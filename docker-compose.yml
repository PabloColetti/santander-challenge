services:
  # ============================================
  # BASE DE DATOS - ms-banks
  # ============================================
  postgres-banks:
    image: postgres:15-alpine
    container_name: postgres-banks
    environment:
      POSTGRES_DB: ${POSTGRES_BANKS_DB:-ms_banks_db}
      POSTGRES_USER: ${POSTGRES_BANKS_USER:-root}
      POSTGRES_PASSWORD: ${POSTGRES_BANKS_PASSWORD:-root}
    ports:
      - "${POSTGRES_BANKS_EXTERNAL_PORT:-5433}:5432"
    volumes:
      - postgres_banks_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_BANKS_USER:-root} -d ${POSTGRES_BANKS_DB:-ms_banks_db}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - santander-network

  # ============================================
  # BASE DE DATOS - ms-accounts
  # ============================================
  postgres-accounts:
    image: postgres:15-alpine
    container_name: postgres-accounts
    environment:
      POSTGRES_DB: ${POSTGRES_ACCOUNTS_DB:-ms_accounts_db}
      POSTGRES_USER: ${POSTGRES_ACCOUNTS_USER:-root}
      POSTGRES_PASSWORD: ${POSTGRES_ACCOUNTS_PASSWORD:-root}
    ports:
      - "${POSTGRES_ACCOUNTS_EXTERNAL_PORT:-5434}:5432"
    volumes:
      - postgres_accounts_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_ACCOUNTS_USER:-root} -d ${POSTGRES_ACCOUNTS_DB:-ms_accounts_db}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - santander-network

  # ============================================
  # MICROSERVICIOS - ms-config / Config Server
  # ============================================
  ms-config:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        JAR_FILE: ms-config/target/ms-config-0.0.1-SNAPSHOT.jar
        EXPOSE_PORT: ${CONFIG_SERVER_PORT:-8888}
    container_name: ms-config
    ports:
      - "${CONFIG_SERVER_PORT:-8888}:${CONFIG_SERVER_PORT:-8888}"
    environment:
      SERVER_PORT: ${CONFIG_SERVER_PORT:-8888}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-native}
      CONFIG_SERVER_NAME: ${CONFIG_SERVER_NAME:-ms-config}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT:-8888}
    healthcheck:
      test:
        ["CMD-SHELL", "nc -z localhost ${CONFIG_SERVER_PORT:-8888} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - santander-network

  # ============================================
  # MICROSERVICIOS - ms-eureka / Service Discovery
  # Depende de ms-config
  # ============================================
  ms-eureka:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        JAR_FILE: ms-eureka/target/ms-eureka-0.0.1-SNAPSHOT.jar
        EXPOSE_PORT: ${EUREKA_SERVER_PORT:-8761}
    container_name: ms-eureka
    ports:
      - "${EUREKA_SERVER_PORT:-8761}:${EUREKA_SERVER_PORT:-8761}"
    environment:
      SERVER_PORT: ${EUREKA_SERVER_PORT:-8761}
      CONFIG_SERVER_NAME: ${CONFIG_SERVER_NAME:-ms-config}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT:-8888}
      EUREKA_SERVER_NAME: ${EUREKA_SERVER_NAME:-ms-eureka}
      EUREKA_SERVER_PORT: ${EUREKA_SERVER_PORT:-8761}
    depends_on:
      ms-config:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --quiet --tries=1 --spider http://localhost:${EUREKA_SERVER_PORT:-8761}/ || exit 1",
        ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - santander-network

  # ============================================
  # MICROSERVICIOS - api-consumer / API Gateway
  # Depende de ms-config, ms-eureka, ms-banks y ms-accounts
  # ============================================
  api-consumer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        JAR_FILE: api-consumer/target/api-consumer-0.0.1-SNAPSHOT.jar
        EXPOSE_PORT: ${API_CONSUMER_PORT:-8080}
    container_name: api-consumer
    ports:
      - "${API_CONSUMER_PORT:-8080}:${API_CONSUMER_PORT:-8080}"
    environment:
      SERVER_PORT: ${API_CONSUMER_PORT:-8080}
      CONFIG_SERVER_NAME: ${CONFIG_SERVER_NAME:-ms-config}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT:-8888}
    depends_on:
      ms-config:
        condition: service_healthy
      ms-eureka:
        condition: service_healthy
      ms-banks:
        condition: service_healthy
      ms-accounts:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD-SHELL", "nc -z localhost ${API_CONSUMER_PORT:-8080} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - santander-network

  # ============================================
  # MICROSERVICIOS - ms-banks / Banks Microservice
  # Depende de ms-config, ms-eureka y postgres-banks
  # ============================================
  ms-banks:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        JAR_FILE: ms-banks/target/ms-banks-0.0.1-SNAPSHOT.jar
        EXPOSE_PORT: ${BANKS_SERVER_PORT:-8090}
    container_name: ms-banks
    ports:
      - "${BANKS_SERVER_PORT:-8090}:${BANKS_SERVER_PORT:-8090}"
    environment:
      SERVER_PORT: ${BANKS_SERVER_PORT:-8090}
      CONFIG_SERVER_NAME: ${CONFIG_SERVER_NAME:-ms-config}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT:-8888}
      SPRING_DATASOURCE_URL: "jdbc:postgresql://${POSTGRES_BANKS_HOST:-postgres-banks}:${POSTGRES_BANKS_PORT:-5432}/${POSTGRES_BANKS_DB:-ms_banks_db}"
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_BANKS_USER:-root}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_BANKS_PASSWORD:-root}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO:-create}
    depends_on:
      ms-config:
        condition: service_healthy
      ms-eureka:
        condition: service_healthy
      postgres-banks:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD-SHELL", "nc -z localhost ${BANKS_SERVER_PORT:-8090} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - santander-network

  # ============================================
  # MICROSERVICIOS - ms-accounts / Accounts Microservice
  # Depende de ms-config, ms-eureka y postgres-accounts
  # ============================================
  ms-accounts:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        JAR_FILE: ms-accounts/target/ms-accounts-0.0.1-SNAPSHOT.jar
        EXPOSE_PORT: ${ACCOUNTS_SERVER_PORT:-9090}
    container_name: ms-accounts
    ports:
      - "${ACCOUNTS_SERVER_PORT:-9090}:${ACCOUNTS_SERVER_PORT:-9090}"
    environment:
      SERVER_PORT: ${ACCOUNTS_SERVER_PORT:-9090}
      CONFIG_SERVER_NAME: ${CONFIG_SERVER_NAME:-ms-config}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT:-8888}
      SPRING_DATASOURCE_URL: "jdbc:postgresql://${POSTGRES_ACCOUNTS_HOST:-postgres-accounts}:${POSTGRES_ACCOUNTS_PORT:-5432}/${POSTGRES_ACCOUNTS_DB:-ms_accounts_db}"
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_ACCOUNTS_USER:-root}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_ACCOUNTS_PASSWORD:-root}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO:-create}
    depends_on:
      ms-config:
        condition: service_healthy
      ms-eureka:
        condition: service_healthy
      postgres-accounts:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD-SHELL", "nc -z localhost ${ACCOUNTS_SERVER_PORT:-9090} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - santander-network

# ============================================
# VOLUMES
# ============================================
volumes:
  postgres_banks_data:
  postgres_accounts_data:

# ============================================
# REDES
# ============================================
networks:
  santander-network:
    driver: bridge
